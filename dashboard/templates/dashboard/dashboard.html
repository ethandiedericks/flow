{% extends '_base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
    Dashboard
{% endblock title %}

{% block body_class %}
    dashboard-page
{% endblock body_class %}

{% block content %}
        <div class="container">
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="dashboard-card income-card">
                        <div class="card-body">
                            <i class="fas fa-money-bill fa-3x"></i> <h5 class="card-title mt-3">Income</h5>
                            <p class="card-text">{{ total_incomes }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="dashboard-card expenses-card">
                        <div class="card-body">
                            <i class="fas fa-shopping-cart fa-3x"></i> <h5 class="card-title mt-3">Expenses</h5>
                            <p class="card-text">{{ total_expenses }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="dashboard-card investments-card">
                        <div class="card-body">
                            <i class="fas fa-chart-pie fa-3x"></i> <h5 class="card-title mt-3">Investments</h5>
                            <p class="card-text">{{ total_investments }}</p>
                        </div>
                    </div>
                </div>
            </div> <!-- closing inner row 1 -->
            <div class="row g-2">
                <div class="col-md-8">
                    <div class="mb-2 mt-0">
                        <div >
                            <select class="form-select big-chart-select" id="smallChartType">
                                <option value="line">Line Chart</option>
                                <option value="bar">Bar Chart</option>
                            </select>
                        </div>
                    </div>
                    <div class="big-chart-card">
                        <canvas id="bigChart" aria-label="bigChart" role="img"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-2 mt-0">
                        <div>
                            <select class="form-select small-chart-select" id="bigChartType">
                                <option value="doughnut">Doughnut Chart</option>
                                <option value="pie">Pie Chart</option>
                            </select>
                        </div>
                    </div>
                    <div class="small-chart-card">
                        <canvas id="smallChart" aria-label="smallChart" role="img"></canvas>
                    </div>
                </div>
            </div> <!-- closing inner row 2-->
            <div class="row">
                <div class="col-md-12">
                    <div class="table-card">
                        <table class="table align-middle mb-0 bg-white table-hover table-responsive caption-top">
                            <caption><strong>List of transactions: </strong> <i>(click to edit or delete)</i> </caption>
                            <thead>
                              <tr>
                                <th>Transaction Type</th>
                                <th>Transaction Name</th>
                                <th>Transaction Amount</th>
                                <th>Future Transaction Date</th>
                              </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                <tr class="transaction-row" data-transaction-id="{{ transaction.id }}" data-bs-toggle="modal" data-bs-target="#editTransactionModal">
                                    <td>{{ transaction.transaction_type }}</td>
                                    <td>{{ transaction.transaction_name }}</td>
                                    <td>{{ transaction.transaction_amount }}</td>
                                    <td>{{ transaction.future_transaction_date }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            
                          </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Edit Transaction Modal -->
        <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editTransactionModalLabel">Edit Transaction</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="editTransactionModalBody">
                        <!-- The form will be loaded here via AJAX -->
                    </div>
                </div>
            </div>
        </div>
        <!-- Delete Transaction Confirmation Modal -->
        <div class="modal fade" id="deleteTransactionModal" tabindex="-1" aria-labelledby="deleteTransactionModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteTransactionModalLabel">Confirm Delete Transaction</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                    <!-- Modal body to display here via AJAX -->
                    </div>
                </div>
            </div>
        </div>
<script>
   $(document).ready(function () {
    var transID = "";
    $('.transaction-row').click(function () {
        var transactionId = $(this).data('transaction-id');
        transID = transactionId;
        var modalBody = $('#editTransactionModalBody');

        // Use AJAX to fetch the form HTML from the server
        $.ajax({
            type: 'GET',
            url: 'edit-transaction/' + transactionId + '/fetch/',
            success: function (data) {
                // Update the modal body with the fetched form HTML
                modalBody.html(data);
            },
            error: function (error) {
                console.log('Error fetching form: ', error);
            }
        });
    });
    // Handle the form submission event
    $('#editTransactionModalBody').on('submit', '#editTransactionForm', function (e) {
        e.preventDefault();

        var form = $(this);
        var formData = form.serialize();

        // Check if the delete button is selected
        var deleteTransaction = form.find('#id_delete').prop('checked');

        if (deleteTransaction) {
            // Perform delete action
            if (confirm('Are you sure you want to delete this transaction?')) {
                $.ajax({
                    type: 'POST',
                    url: form.attr('action'),
                    data: formData,
                    success: function (data) {
                        console.log('Transaction deleted successfully:', data);
                        $('#editTransactionModal').modal('hide');
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        console.error('AJAX error:', status, error);
                        console.log(xhr.responseText);
                    }
                });
            }
        } else {
            // Perform update action
            $.ajax({
                type: 'POST',
                url: form.attr('action'),
                data: formData,
                success: function (data) {
                    console.log('Transaction updated successfully:', data);
                    $('#editTransactionModal').modal('hide');
                    location.reload();
                },
                error: function (xhr, status, error) {
                    console.error('AJAX error:', status, error);
                    console.log(xhr.responseText);

                    // Display server-side validation errors
                    var errors = JSON.parse(xhr.responseText);
                    for (var field in errors) {
                        var errorMessage = errors[field][0];
                        alert(errorMessage);
                    }
                }
            });
        }
    });

    // Handle the delete button click event
    $('#editTransactionModalBody').on('click', '#deleteTransactionBtn', function () {
        // Open the delete confirmation modal
        var transactionId = transID;
        var deleteModalUrl = 'edit-transaction/' + transactionId + '/delete/';
        
        console.log('Transaction ID:', transactionId);
        $.get(deleteModalUrl, function (data) {
            // Replace the content of the delete confirmation modal body with the new data
            $('#deleteTransactionModal .modal-body').html(data);
            // Hide edit modal
            $('#editTransactionModal').modal('hide');
            // Show the delete confirmation modal
            $('#deleteTransactionModal').modal('show');
        });
    });

    
    // Handle the delete confirmation form submission event
    $('body').on('submit', '#deleteTransactionForm', function (e) {
        e.preventDefault();
        
        var deleteForm = $(this);
        var deleteFormData = deleteForm.serialize();
        
        // Perform delete action
        $.ajax({
            type: 'POST',
            url: deleteForm.attr('action'),
            data: deleteFormData,
            success: function (data) {
                console.log('Transaction deleted successfully:', data);
                $('#deleteTransactionModal').modal('hide');
                location.reload();
            },
            error: function (xhr, status, error) {
                console.error('AJAX error:', status, error);
                console.log(xhr.responseText);
            }
        });
    });
});

</script>

{% endblock content %}
